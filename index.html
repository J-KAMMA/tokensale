<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SLT 購入（Sepolia）</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background: #0b0d10; color: #e8ecef; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 24px; }
    .card { background: #12161b; border: 1px solid #1e242b; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; }
    button { cursor: pointer; border: 1px solid #2a3038; background: #1a2028; color: #e8ecef; border-radius: 12px; padding: 10px 14px; font-weight: 600; }
    button.primary { background: #2a6df4; border-color: #2a6df4; color: white; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input, select { width: 100%; box-sizing: border-box; border-radius: 12px; border: 1px solid #2a3038; background: #0e1318; color: #e8ecef; padding: 10px 12px; }
    .grid { display: grid; gap: 14px; }
    .muted { color: #9aa6b2; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hr { height: 1px; background: #1e242b; margin: 14px 0; }
    .pill { background: #0f1720; border: 1px solid #253041; padding: 6px 10px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .stats { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .stat { background:#0f1720; border:1px solid #253041; border-radius:12px; padding:10px 12px; }
    .stat .label { font-size:12px; color:#9aa6b2; }
    .stat .val { font-size:16px; font-weight:700; margin-top:4px; }
    a { color: #7db1ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card grid">
      <h1>SLT 購入（Sepolia）</h1>
      <div class="muted">精度ロスなし・直前再見積り・1%バッファ。ETH/SLT残高と、見積りでUSDも併記します。</div>

      <!-- 残高・所持 -->
      <div class="stats">
        <div class="stat">
          <div class="label">接続アドレス</div>
          <div class="val mono" id="addrShort">未接続</div>
        </div>
        <div class="stat">
          <div class="label">ETH 残高</div>
          <div class="val mono" id="ethBal">-</div>
        </div>
        <div class="stat">
          <div class="label">所持 SLT</div>
          <div class="val mono" id="sltBal">-</div>
        </div>
        <div class="stat">
          <div class="label">コントラクト</div>
          <div class="val mono" id="tokenMeta">-</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="grid">
          <label class="muted">コントラクトアドレス</label>
          <input id="addr" value="0x5a4f4f12242a74094E936B78CA4d7b01415A0cA9" />
        </div>
        <div><button id="useAddr">読み込む</button></div>
      </div>

      <div class="row">
        <div class="grid">
          <label class="muted">購入量（枚 / SLT）</label>
          <input id="amount" type="text" inputmode="decimal" placeholder="例: 0.001" value="0.001" />
        </div>
        <div class="grid" style="width: 180px;">
          <label class="muted">ネットワーク</label>
          <select id="network">
            <option value="11155111" selected>Sepolia</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="grid">
          <button id="btnConnect">ウォレット接続</button>
        </div>
        <div class="grid" style="grid-template-columns:auto auto; gap:8px;">
          <button class="primary" id="btnQuote" disabled>見積り</button>
          <button id="btnRefresh" disabled>残高更新</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="out" class="grid"></div>

      <div class="row">
        <div class="grid">
          <div class="muted">送信直前に再見積り。必要ETHに<b>+1%</b>を <code>maxPayETH</code> として送信（余剰は自動返金）。</div>
        </div>
        <div class="grid">
          <button class="primary" id="btnBuy" disabled>購入（buyWithETH）</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="muted">
        テストネット(Sepolia)用。失敗時はオラクル更新・ガス・ネットワーク切替をご確認ください。
      </div>
    </div>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

    const ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function quoteAll(uint256 dS) view returns (uint256 sNow,uint256 price_btc_e8,uint256 price_eth_1e18,uint256 price_usd_1e6,uint256 cost_btc_e8,uint256 cost_eth_1e18,uint256 cost_usd_1e6,uint256 btcUsd_e8,uint256 ethUsd_e8)",
      "function buyWithETH(uint256 dS, uint256 maxPayETH) payable",
      "function DAO() view returns (address)",
      "function S() view returns (uint256)"
    ];

    const $ = (q)=>document.querySelector(q);
    const addrInput = $("#addr");
    const amountInput = $("#amount");
    const btnConnect = $("#btnConnect");
    const btnQuote = $("#btnQuote");
    const btnBuy = $("#btnBuy");
    const btnRefresh = $("#btnRefresh");
    const out = $("#out");
    const useAddr = $("#useAddr");
    const addrShort = $("#addrShort");
    const ethBalEl = $("#ethBal");
    const sltBalEl = $("#sltBal");
    const tokenMeta = $("#tokenMeta");

    const CHAIN_ID = 11155111; // Sepolia

    let provider, signer, account, contract, decimals = 18, symbol = "SLT";

    function log(lines) {
      const div = document.createElement('div');
      div.className = 'pill mono';
      div.textContent = Array.isArray(lines) ? lines.join(' ') : String(lines);
      out.prepend(div);
    }
    const short = (addr)=> addr ? (addr.slice(0,6)+"…"+addr.slice(-4)) : "-";

    async function ensureSepolia() {
      if (!window.ethereum) throw new Error("ウォレット(例: MetaMask)が必要です");
      const current = await window.ethereum.request({ method: 'eth_chainId' });
      const cid = parseInt(current, 16);
      if (cid !== CHAIN_ID) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0xAA36A7' }], // 11155111
          });
        } catch (e) {
          throw new Error("MetaMaskでSepoliaに切り替えてください");
        }
      }
    }

    async function connect() {
      await ensureSepolia();
      provider = new ethers.BrowserProvider(window.ethereum);
      const accs = await provider.send('eth_requestAccounts', []);
      account = accs[0];
      signer = await provider.getSigner();
      addrShort.textContent = short(account);
      btnQuote.disabled = false;
      btnBuy.disabled = false;
      btnRefresh.disabled = false;
      log(["接続:", account]);
      await loadContract();
      await refreshBalances();
      window.ethereum?.on?.('accountsChanged', async (a)=>{
        account = a[0]; addrShort.textContent = short(account);
        signer = await provider.getSigner();
        await refreshBalances();
      });
      window.ethereum?.on?.('chainChanged', ()=>location.reload());
    }

    async function loadContract() {
      const address = addrInput.value.trim();
      if (!ethers.isAddress(address)) { log("コントラクトアドレスが不正です"); return; }
      const rp = signer ?? (provider || new ethers.JsonRpcProvider("https://rpc.sepolia.org"));
      contract = new ethers.Contract(address, ABI, rp);
      try {
        const [nm, sy, dec] = await Promise.all([contract.name(), contract.symbol(), contract.decimals()]);
        decimals = Number(dec);
        symbol = sy;
        tokenMeta.textContent = `${nm} (${sy}) · decimals=${dec}`;
        log([`読込: ${nm} (${sy}) / decimals=${dec}`]);
      } catch (e) {
        console.error(e);
        tokenMeta.textContent = "読込失敗";
        log("コントラクト読込に失敗しました（Etherscan未検証でも動作可）");
      }
    }

    function validAmountStr(s) { return /^\d+(\.\d+)?$/.test(s); }
    function toWeiTokens(amountStr) { return ethers.parseUnits(amountStr, decimals); }
    function fmtEth(wei) { try { return ethers.formatEther(wei); } catch { return String(wei); } }
    function fmtUnits(v, d) { try { return ethers.formatUnits(v, d); } catch { return String(v); } }

    async function refreshBalances() {
      try {
        if (!provider || !account) return;
        const bal = await provider.getBalance(account);
        ethBalEl.textContent = `${fmtEth(bal)} ETH`;
      } catch { ethBalEl.textContent = "-"; }
      try {
        if (contract && account) {
          const bal = await contract.balanceOf(account);
          sltBalEl.textContent = `${fmtUnits(bal, decimals)} ${symbol}`;
        } else {
          sltBalEl.textContent = "-";
        }
      } catch { sltBalEl.textContent = "-"; }
    }

    async function doQuote() {
      if (!contract) await loadContract();
      const amtStr = (amountInput.value || '').trim();
      if (!validAmountStr(amtStr)) return log("購入量を 0.001 の形式で入力してください");
      const dS = toWeiTokens(amtStr);
      log([`見積り dS=${dS.toString()}`]);
      try {
        const q = await contract.quoteAll(dS);
        const costWei = q.cost_eth_1e18 ?? q[5];
        const priceWei = q.price_eth_1e18 ?? q[2];
        const priceUsd = q.price_usd_1e6 ?? q[3];
        const costUsd  = q.cost_usd_1e6  ?? q[6];
        const btcUsd   = q.btcUsd_e8     ?? q[7];
        const ethUsd   = q.ethUsd_e8     ?? q[8];

        log([`1枚価格: ~${fmtEth(priceWei)} ETH / $${(Number(priceUsd)/1e6).toFixed(2)}`]);
        log([`合計必要: ~${fmtEth(costWei)} ETH / $${(Number(costUsd)/1e6).toFixed(2)}`]);
        log([`参考: BTC/USD=${(Number(btcUsd)/1e8).toFixed(2)}, ETH/USD=${(Number(ethUsd)/1e8).toFixed(2)}`]);
      } catch (e) {
        console.error(e);
        log("見積りに失敗しました（オラクル停止や入力値を確認）");
      }
    }

    async function doBuy() {
      if (!contract || !signer) return log("まずウォレット接続してください");
      const amtStr = (amountInput.value || '').trim();
      if (!validAmountStr(amtStr)) return log("購入量を 0.001 の形式で入力してください");
      const dS = toWeiTokens(amtStr);

      try {
        // 直前再見積り
        const fresh = await contract.quoteAll(dS);
        const need = (fresh.cost_eth_1e18 ?? fresh[5]);
        const costUsd = (fresh.cost_usd_1e6 ?? fresh[6]);
        const maxPay = (need * 101n) / 100n; // +1%

        const tx = await contract.buyWithETH(dS, maxPay, { value: maxPay });
        log([`送信: ${tx.hash}`]);
        const rc = await tx.wait();
        log([`確定ブロック: ${rc.blockNumber}`]);
        log([`支払(概算): ~${fmtEth(need)} ETH / $${(Number(costUsd)/1e6).toFixed(2)}`]);

        setTimeout(refreshBalances, 1500);
      } catch (e) {
        console.error(e);
        log("購入に失敗：残高不足 / ガス不足 / オラクル一時停止 / 48h転送アウト禁止 を確認");
      }
    }

    btnConnect.addEventListener('click', connect);
    btnQuote.addEventListener('click', doQuote);
    btnBuy.addEventListener('click', doBuy);
    btnRefresh.addEventListener('click', refreshBalances);
    useAddr.addEventListener('click', async ()=>{ await loadContract(); await refreshBalances(); });

    // 初期ロード
    (async ()=>{ await loadContract(); })();
  </script>
</body>
</html>
